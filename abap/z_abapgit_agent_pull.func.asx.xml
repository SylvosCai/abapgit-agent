<?xml version="1.0" encoding="utf-8"?>
<abapGit version="v1.0" serializer="LCL_OBJECT_FUNC" serializer_version="1">
  <asx:abap xmlns:asx="http://www.sap.com/abap/asx" version="1.0">
    <asx:values>
      <FUNCNAME>Z_ABAPGIT_AGENT_PULL</FUNCNAME>
      <FUNCTION>
        <SHORT_TEXT>Trigger git pull and activation for a repository</SHORT_TEXT>
      </FUNCTION>
      <IMPORT>
        <PARAMETER>
          <NAME>IV_URL</NAME>
          <TYPE>STRING</TYPE>
          <OPTIONAL></OPTIONAL>
        </PARAMETER>
        <PARAMETER>
          <NAME>IV_BRANCH</NAME>
          <TYPE>STRING</TYPE>
          <DEFAULT>'main'</DEFAULT>
          <OPTIONAL>X</OPTIONAL>
        </PARAMETER>
        <PARAMETER>
          <NAME>IV_ACTIVATE</NAME>
          <TYPE>ABAP_BOOL</TYPE>
          <DEFAULT>ABAP_TRUE</DEFAULT>
          <OPTIONAL>X</OPTIONAL>
        </PARAMETER>
      </IMPORT>
      <EXPORT>
        <PARAMETER>
          <NAME>EV_SUCCESS</NAME>
          <TYPE>ABAP_BOOL</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_JOB_ID</NAME>
          <TYPE>STRING</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_MESSAGE</NAME>
          <TYPE>STRING</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_ACTIVATED_COUNT</NAME>
          <TYPE>I</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_FAILED_COUNT</NAME>
          <TYPE>I</TYPE>
        </PARAMETER>
      </EXPORT>
      <TABLES>
        <PARAMETER>
          <NAME>ET_ERROR_LOG</NAME>
          <TYPE>STRING_TABLE</TYPE>
        </PARAMETER>
      </TABLES>
      <SOURCE>
FUNCTION z_abapgit_agent_pull.
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  IMPORTING
*"    VALUE(IV_URL) TYPE STRING
*"    VALUE(IV_BRANCH) TYPE STRING DEFAULT 'main'
*"    VALUE(IV_ACTIVATE) TYPE ABAP_BOOL DEFAULT ABAP_TRUE
*"  EXPORTING
*"    EV_SUCCESS TYPE ABAP_BOOL
*"    EV_JOB_ID TYPE STRING
*"    EV_MESSAGE TYPE STRING
*"    EV_ACTIVATED_COUNT TYPE I
*"    EV_FAILED_COUNT TYPE I
*"  TABLES
*"    ET_ERROR_LOG TYPE STRING_TABLE
*"----------------------------------------------------------------------
  DATA: lv_job_id TYPE string.
  DATA: ls_result TYPE zif_abapgit_agent=>ty_result.

  CLEAR: et_error_log, ev_message, ev_activated_count, ev_failed_count.

  " Generate unique job ID
  lv_job_id = |{ sy-uname }_{ sy-datetime }_{ sy-uzeit }|.
  CONVERT DATE sy-datum TIME sy-uzeit INTO TIME STAMP DATA(lv_started_at) TIME ZONE sy-tzone.

  " Start background job for pull and activation
  CALL FUNCTION 'JOB_OPEN'
    EXPORTING
      jobname = |ABAPGIT_PULL_{ lv_job_id }|
    IMPORTING
      jobcount = DATA(lv_jobcount).

  " Submit background job
  SUBMIT z_abapgit_agent_pull_job VIA JOB lv_jobcount
    WITH pv_url = iv_url
    WITH pv_branch = iv_branch
    WITH pv_job_id = lv_job_id
    AND RETURN.

  CALL FUNCTION 'JOB_CLOSE'
    EXPORTING
      jobcount  = lv_jobcount
      jobname   = |ABAPGIT_PULL_{ lv_job_id }|
      sdlstrtdt = sy-datum
      sdlstrttm = sy-uzeit.

  " Return immediately - caller should poll for results
  ev_success = abap_true.
  ev_job_id = lv_job_id.
  ev_message = |Pull job started. Poll for results.|.

ENDFUNCTION.
      </SOURCE>
    </asx:values>
  </asx:abap>
</abapGit>
