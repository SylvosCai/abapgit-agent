<?xml version="1.0" encoding="utf-8"?>
<abapGit version="v1.0" serializer="LCL_OBJECT_FUNC" serializer_version="1">
  <asx:abap xmlns:asx="http://www.sap.com/abap/asx" version="1.0">
    <asx:values>
      <FUNCNAME>Z_ABAPGIT_AGENT_GET_STATUS</FUNCNAME>
      <FUNCTION>
        <SHORT_TEXT>Get status and result of a pull/activation job</SHORT_TEXT>
      </FUNCTION>
      <IMPORT>
        <PARAMETER>
          <NAME>IV_JOB_ID</NAME>
          <TYPE>STRING</TYPE>
          <OPTIONAL></OPTIONAL>
        </PARAMETER>
      </IMPORT>
      <EXPORT>
        <PARAMETER>
          <NAME>EV_STATUS</NAME>
          <TYPE>STRING</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_SUCCESS</NAME>
          <TYPE>ABAP_BOOL</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_MESSAGE</NAME>
          <TYPE>STRING</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_ACTIVATED_COUNT</NAME>
          <TYPE>I</TYPE>
        </PARAMETER>
        <PARAMETER>
          <NAME>EV_FAILED_COUNT</NAME>
          <TYPE>I</TYPE>
        </PARAMETER>
      </EXPORT>
      <TABLES>
        <PARAMETER>
          <NAME>ET_ERROR_LOG</NAME>
          <TYPE>STRING_TABLE</TYPE>
        </PARAMETER>
      </TABLES>
      <SOURCE>
FUNCTION z_abapgit_agent_get_status.
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  IMPORTING
*"    VALUE(IV_JOB_ID) TYPE STRING
*"  EXPORTING
*"    EV_STATUS TYPE STRING
*"    EV_SUCCESS TYPE ABAP_BOOL
*"    EV_MESSAGE TYPE STRING
*"    EV_ACTIVATED_COUNT TYPE I
*"    EV_FAILED_COUNT TYPE I
*"  TABLES
*"    ET_ERROR_LOG TYPE STRING_TABLE
*"----------------------------------------------------------------------
  DATA: lv_status TYPE zif_abapgit_agent=>ty_job_status.
  DATA: ls_result TYPE zif_abapgit_agent=>ty_result.

  " Read job status from database table
  SELECT SINGLE * FROM z_abapgit_agent_res
    WHERE job_id = @iv_job_id
    INTO @DATA(ls_log_entry).

  IF sy-subrc <> 0.
    ev_status = 'NOT_FOUND'.
    ev_success = abap_false.
    ev_message = |Job { iv_job_id } not found|.
    RETURN.
  ENDIF.

  " Get job result
  SELECT SINGLE * FROM z_abapgit_agent_res
    WHERE job_id = @iv_job_id
    INTO @ls_result.

  IF sy-subrc = 0.
    ev_status = ls_result-status.
    ev_success = ls_result-success.
    ev_message = ls_result-message.
    ev_activated_count = ls_result-activated_count.
    ev_failed_count = ls_result-failed_count.

    " Get error log
    SELECT message FROM z_abapgit_agent_err
      WHERE job_id = @iv_job_id
      INTO TABLE @et_error_log.
  ELSE.
    " Job is still running
    ev_status = 'RUNNING'.
    ev_success = abap_true.
    ev_message = 'Job still running'.
  ENDIF.

ENDFUNCTION.
      </SOURCE>
    </asx:values>
  </asx:abap>
</abapGit>
