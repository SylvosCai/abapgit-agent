#!/bin/bash
# abap-ref - Search ABAP cheat sheets for patterns
# Usage: abap-ref <pattern>
#        abap-ref --topic <topic_name>
#
# This script auto-detects the reference folder location from .abapGitAgent
# or falls back to common locations.

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Function to detect reference folder
get_ref_folder() {
    local config_file="$PROJECT_ROOT/.abapGitAgent"
    local ref_folder=""

    # Try to extract from config file
    if [ -f "$config_file" ]; then
        ref_folder=$(grep -o '"referenceFolder"[^}]*' "$config_file" | cut -d'"' -f4 || true)
    fi

    # Fallback to common locations
    if [ -z "$ref_folder" ]; then
        for path in "$HOME/abap-reference" "$HOME/Documents/abap-reference" "$HOME/Documents/code/abap-reference"; do
            if [ -d "$path/abap-cheat-sheets" ]; then
                echo "$path"
                return 0
            fi
        done
    fi

    if [ -n "$ref_folder" ] && [ -d "$ref_folder/abap-cheat-sheets" ]; then
        echo "$ref_folder"
        return 0
    fi

    return 1
}

# Get filename for a topic (bash 3.2 compatible)
get_topic_file() {
    case "$1" in
        internal-tables) echo "01_Internal_Tables.md" ;;
        structures) echo "02_Structures.md" ;;
        sql) echo "03_ABAP_SQL.md" ;;
        oop|objects) echo "04_ABAP_Object_Orientation.md" ;;
        constructors|constructor) echo "05_Constructor_Expressions.md" ;;
        dynamic|rtti) echo "06_Dynamic_Programming.md" ;;
        strings|string) echo "07_String_Processing.md" ;;
        eml) echo "08_EML_ABAP_for_RAP.md" ;;
        hierarchies) echo "10_ABAP_SQL_Hierarchies.md" ;;
        grouping) echo "11_Internal_Tables_Grouping.md" ;;
        amdp) echo "12_AMDP.md" ;;
        flow) echo "13_Program_Flow_Logic.md" ;;
        unit-tests|unit|testing) echo "14_ABAP_Unit_Tests.md" ;;
        cds) echo "15_CDS_View_Entities.md" ;;
        datatypes) echo "16_Data_Types_and_Objects.md" ;;
        luw) echo "17_SAP_LUW.md" ;;
        dynpro) echo "18_Dynpro.md" ;;
        cloud) echo "19_ABAP_for_Cloud_Development.md" ;;
        selection-screens) echo "20_Selection_Screens_Lists.md" ;;
        json-xml|json|xml) echo "21_XML_JSON.md" ;;
        released-classes) echo "22_Released_ABAP_Classes.md" ;;
        datetime) echo "23_Date_and_Time.md" ;;
        functions) echo "24_Builtin_Functions.md" ;;
        auth|authorization) echo "25_Authorization_Checks.md" ;;
        dictionary) echo "26_ABAP_Dictionary.md" ;;
        exceptions|exception) echo "27_Exceptions.md" ;;
        regex) echo "28_Regular_Expressions.md" ;;
        numeric) echo "29_Numeric_Operations.md" ;;
        ai) echo "30_Generative_AI.md" ;;
        where) echo "31_WHERE_Conditions.md" ;;
        performance) echo "32_Performance_Notes.md" ;;
        news) echo "33_ABAP_Release_News.md" ;;
        patterns|design-patterns) echo "34_OO_Design_Patterns.md" ;;
        badis) echo "35_BAdIs.md" ;;
        rap) echo "36_RAP_Behavior_Definition_Language.md" ;;
        tables) echo "01_Internal_Tables.md" ;;
        *) echo "" ;;
    esac
}

# Show help
show_help() {
    cat << EOF
ABAP Reference Search Tool

Usage:
  abap-ref <pattern>           Search for pattern in cheat sheets
  abap-ref --topic <topic>     Search by topic keyword
  abap-ref --list-topics       List available topics
  abap-ref --help              Show this help

Examples:
  abap-ref "CORRESPONDING"
  abap-ref "CX_SY_"
  abap-ref --topic exceptions
  abap-ref --topic sql

Configuration:
  Set 'referenceFolder' in .abapGitAgent to specify cheat sheets location.
  Falls back to common locations (~/abap-reference, ~/Documents/abap-reference).
EOF
}

# List available topics
list_topics() {
    local ref_folder
    if ! ref_folder=$(get_ref_folder); then
        echo -e "${RED}Error: Reference folder not found.${NC}"
        echo "Configure 'referenceFolder' in .abapGitAgent or clone to ~/abap-reference"
        exit 1
    fi

    local cheat_sheets="$ref_folder/abap-cheat-sheets"

    echo -e "${GREEN}Available ABAP Reference Topics:${NC}"
    echo ""

    printf "%-20s %s\n" "Topic" "File"
    echo "----------------------------------------------"

    # List common topics
    local topics="internal-tables sql oop constructors exceptions unit-tests cds json xml performance patterns dynamic strings auth"
    for topic in $topics; do
        local file=$(get_topic_file "$topic")
        if [ -n "$file" ] && [ -f "$cheat_sheets/$file" ]; then
            printf "${GREEN}%-20s${NC} %s\n" "$topic" "$file"
        fi
    done
}

# Search by topic
search_topic() {
    local topic="$1"
    local ref_folder
    if ! ref_folder=$(get_ref_folder); then
        echo -e "${RED}Error: Reference folder not found.${NC}"
        echo "Configure 'referenceFolder' in .abapGitAgent or clone to ~/abap-reference"
        exit 1
    fi

    local cheat_sheets="$ref_folder/abap-cheat-sheets"
    local file=$(get_topic_file "$topic")

    if [ -z "$file" ]; then
        echo -e "${RED}Unknown topic: $topic${NC}"
        echo "Use --list-topics to see available topics"
        exit 1
    fi

    local filepath="$cheat_sheets/$file"
    if [ -f "$filepath" ]; then
        echo -e "${GREEN}Opening: $file${NC}"
        echo ""
        head -100 "$filepath"
        echo ""
        echo -e "${YELLOW}... (truncated, see full file at: $filepath)${NC}"
    else
        echo -e "${RED}File not found: $file${NC}"
        exit 1
    fi
}

# Search for pattern
search_pattern() {
    local pattern="$1"
    local ref_folder
    if ! ref_folder=$(get_ref_folder); then
        echo -e "${RED}Error: Reference folder not found.${NC}"
        echo ""
        echo "To fix this, either:"
        echo "1. Set referenceFolder in .abapGitAgent:"
        echo '   { "referenceFolder": "'"$HOME"'/abap-reference" }'
        echo ""
        echo "2. Clone cheat sheets to a common location:"
        echo "   mkdir -p ~/abap-reference"
        echo "   cd ~/abap-reference"
        echo "   git clone https://github.com/SAP-samples/abap-cheat-sheets.git"
        exit 1
    fi

    local cheat_sheets="$ref_folder/abap-cheat-sheets"

    echo -e "${GREEN}Searching for: '$pattern'${NC}"
    echo -e "${YELLOW}Reference folder: $ref_folder${NC}"
    echo ""

    # Search for files containing the pattern
    local matches=$(grep -ri "$pattern" "$cheat_sheets" --include="*.md" -l 2>/dev/null || true)

    if [ -z "$matches" ]; then
        echo -e "${YELLOW}No matches found.${NC}"
        exit 0
    fi

    echo -e "${GREEN}Found in files:${NC}"
    echo "$matches" | while read -r file; do
        local basename=$(basename "$file")
        echo "  - $basename"
    done
    echo ""

    # Show preview of first few matches
    echo -e "${GREEN}Preview (first 5 matches):${NC}"
    echo "----------------------------------------"
    grep -ri "$pattern" "$cheat_sheets" --include="*.md" -B 1 -A 2 2>/dev/null | head -50
    echo ""
}

# Main logic
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --list-topics|--topics|-l)
        list_topics
        ;;
    --topic|-t)
        if [ -z "${2:-}" ]; then
            echo -e "${RED}Error: No topic specified${NC}"
            echo "Use --list-topics to see available topics"
            exit 1
        fi
        search_topic "$2"
        ;;
    "")
        echo -e "${RED}Error: No pattern specified${NC}"
        show_help
        exit 1
        ;;
    *)
        search_pattern "$1"
        ;;
esac
