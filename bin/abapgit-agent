#!/usr/bin/env node
/**
 * ABAP Git Agent - CLI Tool
 *
 * Usage:
 *   abapgit-agent pull [--branch <branch>]
 *   abapgit-agent pull --url <git-url> [--branch <branch>]
 *   abapgit-agent health
 *   abapgit-agent status
 *
 * Auto-detects git remote URL and branch from current directory.
 */

const path = require('path');
const fs = require('fs');

const COOKIE_FILE = '.abapgit_agent_cookies.txt';

/**
 * Load configuration from .abapGitAgent in current working directory
 */
function loadConfig() {
  const repoConfigPath = path.join(process.cwd(), '.abapGitAgent');

  if (fs.existsSync(repoConfigPath)) {
    return JSON.parse(fs.readFileSync(repoConfigPath, 'utf8'));
  }

  // Fallback to environment variables
  return {
    host: process.env.ABAP_HOST,
    sapport: parseInt(process.env.ABAP_PORT, 10) || 443,
    client: process.env.ABAP_CLIENT || '100',
    user: process.env.ABAP_USER,
    password: process.env.ABAP_PASSWORD,
    language: process.env.ABAP_LANGUAGE || 'EN',
    gitUsername: process.env.GIT_USERNAME,
    gitPassword: process.env.GIT_PASSWORD
  };
}

/**
 * Check if ABAP integration is configured for this repo
 */
function isAbapIntegrationEnabled() {
  const repoConfigPath = path.join(process.cwd(), '.abapGitAgent');
  return fs.existsSync(repoConfigPath);
}

/**
 * Get git remote URL from .git/config
 */
function getGitRemoteUrl() {
  const gitConfigPath = path.join(process.cwd(), '.git', 'config');

  if (!fs.existsSync(gitConfigPath)) {
    return null;
  }

  const content = fs.readFileSync(gitConfigPath, 'utf8');
  const remoteMatch = content.match(/\[remote "origin"\]/);

  if (!remoteMatch) {
    return null;
  }

  const urlMatch = content.match(/	url = (.+)/);
  return urlMatch ? urlMatch[1].trim() : null;
}

/**
 * Get current git branch
 */
function getGitBranch() {
  const headPath = path.join(process.cwd(), '.git', 'HEAD');

  if (!fs.existsSync(headPath)) {
    return 'main';
  }

  const content = fs.readFileSync(headPath, 'utf8').trim();
  const match = content.match(/ref: refs\/heads\/(.+)/);
  return match ? match[1] : 'main';
}

/**
 * Read cookies from file
 * Supports both Netscape format and simple cookie string format
 */
function readNetscapeCookies() {
  const cookiePath = path.join(process.cwd(), COOKIE_FILE);
  if (!fs.existsSync(cookiePath)) return '';

  const content = fs.readFileSync(cookiePath, 'utf8').trim();
  if (!content) return '';

  // Check if it's Netscape format (has tabs)
  if (content.includes('\t')) {
    const lines = content.split('\n');
    const cookies = [];

    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed || (trimmed.startsWith('#') && !trimmed.startsWith('#HttpOnly'))) continue;

      const parts = trimmed.split('\t');
      if (parts.length >= 7) {
        cookies.push(`${parts[5]}=${parts[6]}`);
      }
    }

    return cookies.join('; ');
  }

  // Simple format - just return as-is
  return content;
}

/**
 * Save cookies to Netscape format cookie file
 */
function saveCookies(cookies, host) {
  const cookiePath = path.join(process.cwd(), COOKIE_FILE);

  // Parse cookies and convert to Netscape format
  const cookieList = cookies.split(';').map(c => c.trim()).filter(Boolean);
  const lines = ['# Netscape HTTP Cookie File', '# https://curl.se/docs/http-cookies.html', '# This file was generated by libcurl! Edit at your own risk.'];

  for (const cookie of cookieList) {
    const [name, ...valueParts] = cookie.split('=');
    const value = valueParts.join('=');

    // HttpOnly cookies get #HttpOnly_ prefix
    const domain = name.includes('SAP') || name.includes('MYSAP') || name.includes('SAPLOGON')
      ? `#HttpOnly_${host}`
      : host;

    // Format: domain, flag, path, secure, expiration, name, value
    lines.push(`${domain}\tFALSE\t/\tFALSE\t0\t${name.trim()}\t${value}`);
  }

  fs.writeFileSync(cookiePath, lines.join('\n'));
}

/**
 * Fetch CSRF token using GET /pull with X-CSRF-Token: fetch
 */
async function fetchCsrfToken(config) {
  const https = require('https');
  const url = new URL(`/sap/bc/z_abapgit_agent/health`, `https://${config.host}:${config.sapport}`);

  return new Promise((resolve, reject) => {
    const cookieHeader = readNetscapeCookies();

    const options = {
      hostname: url.hostname,
      port: url.port,
      path: url.pathname,
      method: 'GET',
      headers: {
        'Authorization': `Basic ${Buffer.from(`${config.user}:${config.password}`).toString('base64')}`,
        'sap-client': config.client,
        'sap-language': config.language || 'EN',
        'X-CSRF-Token': 'fetch',
        'Content-Type': 'application/json',
        ...(cookieHeader && { 'Cookie': cookieHeader })
      },
      agent: new https.Agent({ rejectUnauthorized: false })
    };

    const req = https.request(options, (res) => {
      const csrfToken = res.headers['x-csrf-token'];

      // Save new cookies from response
      const setCookie = res.headers['set-cookie'];
      if (setCookie) {
        const cookies = Array.isArray(setCookie)
          ? setCookie.map(c => c.split(';')[0]).join('; ')
          : setCookie.split(';')[0];
        saveCookies(cookies, config.host);
      }

      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        resolve(csrfToken);
      });
    });

    req.on('error', reject);
    req.end();
  });
}

/**
 * Make HTTP request to ABAP REST endpoint
 */
function request(method, path, data = null, options = {}) {
  return new Promise((resolve, reject) => {
    const https = require('https');
    const http = require('http');
    const config = loadConfig();
    const url = new URL(path, `https://${config.host}:${config.sapport}`);

    const headers = {
      'Content-Type': 'application/json',
      'sap-client': config.client,
      'sap-language': config.language || 'EN',
      ...options.headers
    };

    // Add authorization
    headers['Authorization'] = `Basic ${Buffer.from(`${config.user}:${config.password}`).toString('base64')}`;

    // Add CSRF token for POST
    if (method === 'POST' && options.csrfToken) {
      headers['X-CSRF-Token'] = options.csrfToken;
    }

    // Add cookies if available
    const cookieHeader = readNetscapeCookies();
    if (cookieHeader) {
      headers['Cookie'] = cookieHeader;
    }

    const reqOptions = {
      hostname: url.hostname,
      port: url.port,
      path: url.pathname,
      method,
      headers,
      agent: new https.Agent({ rejectUnauthorized: false })
    };

    const req = (url.protocol === 'https:' ? https : http).request(reqOptions, (res) => {
      let body = '';
      res.on('data', chunk => body += chunk);
      res.on('end', () => {
        try {
          // Handle unescaped newlines from ABAP - replace actual newlines with \n
          const cleanedBody = body.replace(/\n/g, '\\n');
          resolve(JSON.parse(cleanedBody));
        } catch (e) {
          // Fallback: try to extract JSON from response
          const jsonMatch = body.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            try {
              resolve(JSON.parse(jsonMatch[0].replace(/\n/g, '\\n')));
            } catch (e2) {
              resolve({ raw: body, error: e2.message });
            }
          } else {
            resolve({ raw: body, error: e.message });
          }
        }
      });
    });

    req.on('error', reject);

    if (data) {
      req.write(JSON.stringify(data));
    }
    req.end();
  });
}

/**
 * Pull and activate repository
 */
async function pull(gitUrl, branch = 'main') {
  console.log(`\nüöÄ Starting pull for: ${gitUrl}`);
  console.log(`   Branch: ${branch}`);

  try {
    const config = loadConfig();

    // Fetch CSRF token first
    const csrfToken = await fetchCsrfToken(config);

    // Prepare request data with git credentials
    const data = {
      url: gitUrl,
      branch: branch,
      username: config.gitUsername,
      password: config.gitPassword
    };

    const result = await request('POST', '/sap/bc/z_abapgit_agent/pull', data, { csrfToken });

    console.log('\n');

    // Display raw result for debugging
    if (process.env.DEBUG) {
      console.log('Raw result:', JSON.stringify(result, null, 2));
    }

    if (result.success === 'X' || result.success === true) {
      console.log(`‚úÖ Pull completed successfully!`);
      console.log(`   Job ID: ${result.job_id || 'N/A'}`);
      console.log(`   Message: ${result.message || 'N/A'}`);
    } else {
      console.log(`‚ùå Pull completed with errors!`);
      console.log(`   Job ID: ${result.job_id || 'N/A'}`);
      console.log(`   Message: ${result.message || 'N/A'}`);
    }

    // Display activated objects
    if (result.activated_objects && result.activated_objects.length > 0) {
      console.log(`\nüì¶ Activated Objects (${result.activated_count}):`);
      for (const obj of result.activated_objects) {
        const objKey = obj.obj_type && obj.obj_name ? `${obj.obj_type} ${obj.obj_name}` : '';
        console.log(`   ‚úì ${objKey}`);
      }
    } else if (result.activated_count > 0) {
      console.log(`\nüì¶ Activated Objects (${result.activated_count})`);
    }

    // Display failed objects
    if (result.failed_objects && result.failed_objects.length > 0) {
      console.log(`\n‚ö†Ô∏è  Failed Objects (${result.failed_count}):`);
      for (const obj of result.failed_objects) {
        const objKey = obj.obj_type && obj.obj_name ? `${obj.obj_type} ${obj.obj_name}` : '';
        const text = obj.text ? `: ${obj.text}` : '';
        console.log(`   ‚úó ${objKey}${text}`);
      }
    } else if (result.failed_count > 0) {
      console.log(`\n‚ö†Ô∏è  Failed Objects (${result.failed_count})`);
    }

    // Show error details if any
    if (result.error_detail) {
      console.log(`\nüìã Error Details:`);
      console.log(result.error_detail);
    }

    return result;
  } catch (error) {
    console.error(`\n‚ùå Error: ${error.message}`);
    process.exit(1);
  }
}

/**
 * Check agent health
 */
async function healthCheck() {
  try {
    const result = await request('GET', '/sap/bc/z_abapgit_agent/health');
    console.log(JSON.stringify(result, null, 2));
    return result;
  } catch (error) {
    console.error(`Health check failed: ${error.message}`);
    process.exit(1);
  }
}

/**
 * Main CLI
 */
async function main() {
  const args = process.argv.slice(2);
  const command = args[0];

  // Check if ABAP integration is enabled for this repo
  if (!isAbapIntegrationEnabled()) {
    console.log(`
‚ö†Ô∏è  ABAP Git Agent not configured for this repository.

To enable integration:
1. Create a .abapGitAgent file in the repo root with ABAP connection details:
{
  "host": "your-sap-system.com",
  "sapport": 443,
  "client": "100",
  "user": "TECH_USER",
  "password": "your-password",
  "language": "EN"
}

2. Or set environment variables:
   - ABAP_HOST, ABAP_PORT, ABAP_CLIENT, ABAP_USER, ABAP_PASSWORD
`);
    if (command !== 'help' && command !== '--help' && command !== '-h') {
      process.exit(1);
    }
  }

  try {
    switch (command) {
      case 'pull':
        const urlArgIndex = args.indexOf('--url');
        const branchArgIndex = args.indexOf('--branch');

        // Auto-detect git remote URL if not provided
        let gitUrl = urlArgIndex !== -1 ? args[urlArgIndex + 1] : null;
        let branch = branchArgIndex !== -1 ? args[branchArgIndex + 1] : getGitBranch();

        if (!gitUrl) {
          gitUrl = getGitRemoteUrl();
          if (!gitUrl) {
            console.error('Error: Not in a git repository or no remote configured.');
            console.error('Either run from a git repo, or specify --url <git-url>');
            process.exit(1);
          }
          console.log(`üìå Auto-detected git remote: ${gitUrl}`);
        }

        await pull(gitUrl, branch);
        break;

      case 'health':
        await healthCheck();
        break;

      case 'status':
        if (isAbapIntegrationEnabled()) {
          console.log('‚úÖ ABAP Git Agent is ENABLED');
          console.log('   Config location:', path.join(process.cwd(), '.abapGitAgent'));
        } else {
          console.log('‚ùå ABAP Git Agent is NOT configured');
        }
        break;

      case 'help':
      case '--help':
      case '-h':
        console.log(`
ABAP Git Agent

Usage:
  abapgit-agent <command> [options]

Commands:
  pull [--url <git-url>] [--branch <branch>]
    Pull and activate repository in ABAP system.
    Auto-detects git remote and branch from current directory.

  health
    Check if ABAP REST API is healthy

  status
    Check if ABAP integration is configured for this repo

Examples:
  abapgit-agent pull                       # Auto-detect from git repo
  abapgit-agent pull --branch develop      # Use specific branch
  abapgit-agent pull --url <git-url>       # Override remote URL
  abapgit-agent health
  abapgit-agent status
`);
        break;

      default:
        console.error(`Unknown command: ${command}`);
        console.error('Use: abapgit-agent help');
        process.exit(1);
    }
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }
}

main();
